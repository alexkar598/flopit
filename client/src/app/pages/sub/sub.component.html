<div class="page">
  <app-top-post-list [subName]="(route.paramMap | async)!.get('subName')!" />

  <div class="sidebar">
    @if (sub$ | async; as sub) {
      <nb-card class="barre-infos">
        <nb-card-header
          style="background-image: linear-gradient(darkgrey), url('{{
            sub.bannerUrl ?? ''
          }}');"
        >
          <div>
            <h1 class="nom-sub">f/{{ sub.name }}</h1>
          </div>

          <div>
            @if (this.editing) {
              <input
                class="input-param"
                type="file"
                accept="image/png, image/jpeg, image/gif, image/ico, image/webp, image/heic, image/avif"
                (change)="onIconChange($event.target)"
                hidden
                #iconPicker
              />
              <button
                class="icon-button"
                nbButton
                outline
                size="large"
                shape="round"
                (click)="iconPicker.click()"
              >
                <nb-icon icon="image-outline" />
              </button>
            } @else {
              @if (sub.iconUrl) {
                <nb-user
                  onlyPicture
                  [picture]="sub.iconUrl"
                  color="#fff"
                  size="large"
                />
              } @else {
                <nb-icon class="icone" icon="globe-2-outline" />
              }
            }
          </div>

          @if (this.editing) {
            <input
              class="input-param"
              type="file"
              accept="image/png, image/jpeg, image/gif, image/ico, image/webp, image/heic, image/avif"
              (change)="onBannerChange($event.target)"
              hidden
              #bannerPicker
            />
            <button
              class="banner-button"
              nbButton
              outline
              size="large"
              shape="round"
              (click)="bannerPicker.click()"
            >
              <nb-icon icon="image-outline" />
            </button>
          }
        </nb-card-header>

        <nb-card-body>
          <button
            nbButton
            [status]="sub.isFollowing ? 'basic' : 'primary'"
            class="bouton-rejoindre"
            (click)="toggleFollow()"
          >
            {{ sub.isFollowing ? "Quitter" : "Rejoindre" }}
          </button>

          @if (!sub.isModerator) {
            <p>{{ sub.description }}</p>
          } @else {
            @if (this.editing) {
              <!--
              https://css-tricks.com/the-cleanest-trick-for-autogrowing-textareas/
              i hate this
              -->
              <div
                class="grow-wrap"
                [attr.data-replicated-value]="newDescription"
              >
                <textarea
                  rows="1"
                  maxlength="512"
                  placeholder="Description"
                  [(ngModel)]="newDescription"
                ></textarea>
              </div>
            } @else {
              <p>{{ sub.description }}</p>
            }

            <div class="edit-description">
              @if (this.editing) {
                <button
                  class="edit-button"
                  nbButton
                  size="large"
                  shape="round"
                  (click)="editDescription()"
                >
                  <nb-icon icon="close-outline" />
                </button>
              }

              <button
                class="edit-button"
                nbButton
                size="large"
                shape="round"
                (click)="this.editing ? saveDescription() : editDescription()"
              >
                <nb-icon
                  [icon]="this.editing ? 'checkmark-outline' : 'edit-outline'"
                />
              </button>
            </div>
          }

          <div class="stats-item">
            <div class="stats">
              <span class="stats-data">{{ sub.followers.totalCount }}</span>
              <p>Membre{{ sub.followers.totalCount !== 1 ? "s" : "" }}</p>
            </div>

            <div class="stats">
              <span class="stats-data">{{ sub.posts.totalCount }}</span>
              <p>Publication{{ sub.posts.totalCount !== 1 ? "s" : "" }}</p>
            </div>
          </div>

          @if (sub.isModerator) {
            <hr />
            <nb-actions class="moderator-actions" [fullWidth]="true">
              <nb-action (click)="openModeratorsWindow()">
                <nb-icon icon="people-outline" />
                Gérer modérateurs
              </nb-action>
            </nb-actions>
          }
        </nb-card-body>
      </nb-card>
    } @else {
      <nb-card class="barre-infos-loading">
        <nb-spinner message="" />
      </nb-card>
    }
  </div>
</div>
